#!/bin/bash
set -e

SOURCE_DIR=$1
BASE_DIR=$2
WORK_DIR="$(pwd)/workspace"
OUT_DIR="$WORK_DIR/out"
MNT_SYS="$WORK_DIR/mnt_system"

mkdir -p "$OUT_DIR" "$MNT_SYS"

echo "=== STARTING ADVANCED PORTING FOR POCO F3 ==="

# 1. –ü–û–î–ì–û–¢–û–í–ö–ê SYSTEM.IMG
# –ò—â–µ–º system.img (–∏–Ω–æ–≥–¥–∞ –æ–Ω –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è system_root.img)
SYS_IMG=$(find "$SOURCE_DIR" -name "system.img" -o -name "system_root.img" | head -n 1)

if [ -z "$SYS_IMG" ]; then
    echo "‚ùå Error: System image not found in Source!"
    exit 1
fi

echo "Found System: $SYS_IMG"

# –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Sparse -> Raw (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
if file "$SYS_IMG" | grep -q "sparse"; then
    echo "Converting sparse system to raw..."
    simg2img "$SYS_IMG" "${SYS_IMG}.raw"
    mv "${SYS_IMG}.raw" "$SYS_IMG"
fi

# –†–∞—Å—à–∏—Ä—è–µ–º –æ–±—Ä–∞–∑, —á—Ç–æ–±—ã –±—ã–ª–æ –º–µ—Å—Ç–æ –¥–ª—è –ø—Ä–∞–≤–æ–∫ (+300–ú–±)
e2fsck -f -y "$SYS_IMG" || true
resize2fs "$SYS_IMG" 4G || true

# –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
echo "Mounting System..."
sudo mount -t ext4 -o rw,loop "$SYS_IMG" "$MNT_SYS"

# ==========================================
# üíÄ –ó–û–ù–ê –ú–û–î–ò–§–ò–ö–ê–¶–ò–ò (BOOTLOOP FIXES)
# ==========================================

echo "üîß 1. Fixing Build.prop (Spoofing Alioth)..."
# –ü–æ–¥–º–µ–Ω—è–µ–º –º–æ–¥–µ–ª—å, —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å—ã Xiaomi/Google –¥—É–º–∞–ª–∏, —á—Ç–æ —ç—Ç–æ Poco F3
for prop in "$MNT_SYS/system/build.prop" "$MNT_SYS/build.prop"; do
    if [ -f "$prop" ]; then
        sudo sed -i 's/^ro.product.model=.*/ro.product.model=M2012K11AC/' "$prop"
        sudo sed -i 's/^ro.product.device=.*/ro.product.device=alioth/' "$prop"
        sudo sed -i 's/^ro.product.brand=.*/ro.product.brand=POCO/' "$prop"
        sudo sed -i 's/^ro.product.name=.*/ro.product.name=alioth_global/' "$prop"
        # –û—Ç–∫–ª—é—á–∞–µ–º secure boot —Ñ–ª–∞–≥–∏
        echo "ro.secure=0" | sudo tee -a "$prop"
        echo "ro.adb.secure=0" | sudo tee -a "$prop"
        echo "ro.debuggable=1" | sudo tee -a "$prop"
    fi
done

echo "üîß 2. Fixing Fstab (Critical for booting)..."
# –£–¥–∞–ª—è–µ–º fstab –¥–æ–Ω–æ—Ä–∞, —Ç–∞–∫ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª—ã –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è
sudo rm -f "$MNT_SYS/system/etc/fstab*"
sudo rm -f "$MNT_SYS/system/vendor/etc/fstab*" 2>/dev/null || true

# –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å Vendor –æ—Ç –±–∞–∑—ã, –±–µ—Ä–µ–º fstab –æ—Ç—Ç—É–¥–∞ (—ç—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ)
# –ù–æ Vendor –≤ —Ñ–æ—Ä–º–∞—Ç–µ .img, –º—ã –µ–≥–æ –Ω–µ –º–æ–Ω—Ç–∏—Ä—É–µ–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏.
# –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–¥–∏–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fstab –¥–ª—è Qualcomm (Poco F3)
cat <<EOF | sudo tee "$MNT_SYS/system/etc/fstab.qcom"
# Android fstab file for Alioth (Generated by Script)
system       /system       ext4    ro,barrier=1    wait,avb=vbmeta_system,logical,first_stage_mount
vendor       /vendor       ext4    ro,barrier=1    wait,avb,logical,first_stage_mount
product      /product      ext4    ro,barrier=1    wait,avb,logical,first_stage_mount
/dev/block/bootdevice/by-name/metadata /metadata ext4 noatime,nosuid,nodev,discard wait,check,formattable
/dev/block/bootdevice/by-name/userdata /data     f2fs noatime,nosuid,nodev,discard,inline_xattr,inline_data,inline_dentry,flush_merge,reserve_root=134217,resgid=1065,fsync_mode=nobarrier latemount,wait,check,formattable,quota,reservedsize=128M
EOF

echo "üîß 3. Patching Init.rc (Disable AVB/Verity)..."
# –ò—â–µ–º –≤—Å–µ init —Å–∫—Ä–∏–ø—Ç—ã –∏ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
find "$MNT_SYS/system/etc/init" -name "*.rc" -type f | while read rc; do
    # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ verify (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏)
    sudo sed -i '/verify/d' "$rc"
    # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ avb (android verified boot)
    sudo sed -i '/avb/d' "$rc"
done

echo "üîß 4. Fixing SELinux (Permissive)..."
# –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –≥—Ä—É–∑–∏—Ç—å—Å—è –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –¥–æ—Å—Ç—É–ø–∞
# –î–æ–±–∞–≤–ª—è–µ–º –≤ init.rc –∫–æ–º–∞–Ω–¥—É setenforce 0 –≤ –Ω–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏
INIT_MAIN="$MNT_SYS/system/etc/init/hw/init.rc"
if [ -f "$INIT_MAIN" ]; then
    # –í—Å—Ç–∞–≤–ª—è–µ–º setenforce 0 –ø–æ—Å–ª–µ 'on early-init'
    sudo sed -i '/on early-init/a \    exec u:r:su:s0 root root -- /system/bin/setenforce 0' "$INIT_MAIN"
fi

echo "üîß 5. Removing Conflict Files..."
# –£–¥–∞–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–æ–∫–æ–≤—ã–π recovery
sudo rm -f "$MNT_SYS/system/recovery-from-boot.p"
# –£–¥–∞–ª—è–µ–º –æ–≤–µ—Ä–ª–µ–∏ –¥–æ–Ω–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ª–æ–º–∞—Ç—å UI (—á–µ–ª–∫—É)
# (–≠—Ç–æ –≥—Ä—É–±–æ, –Ω–æ –ª—É—á—à–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á–µ–º —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω)
# sudo rm -rf "$MNT_SYS/product/overlay/*" 

# ==========================================
# üíæ –ó–ê–ü–ê–ö–û–í–ö–ê
# ==========================================

echo "Unmounting System..."
sudo umount "$MNT_SYS"

echo "Optimizing System Image size..."
# –°–∂–∏–º–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ sparse, —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä ZIP
img2simg "$SYS_IMG" "$OUT_DIR/system.img"

echo "Copying Base Kernel & Vendor..."
# –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –≤–∞–∂–Ω—ã —Ä–æ–¥–Ω–æ–π Vendor –∏ Boot –æ—Ç Poco F3
cp "$BASE_DIR/boot.img" "$OUT_DIR/"
cp "$BASE_DIR/vendor.img" "$OUT_DIR/"
# –ï—Å–ª–∏ –µ—Å—Ç—å vbmeta (–æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏), –∫–ª–∞–¥–µ–º –µ–µ.
# –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—á–µ–Ω–Ω—É—é vbmeta (—Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º verity), –Ω–æ –±–µ—Ä–µ–º —Å—Ç–æ–∫ –æ—Ç –±–∞–∑—ã
[ -f "$BASE_DIR/vbmeta.img" ] && cp "$BASE_DIR/vbmeta.img" "$OUT_DIR/"
[ -f "$BASE_DIR/dtbo.img" ] && cp "$BASE_DIR/dtbo.img" "$OUT_DIR/"

echo "Generating generic Updater-Script..."
mkdir -p "$OUT_DIR/META-INF/com/google/android"

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è TWRP (Dynamic partitions)
cat <<EOF > "$OUT_DIR/META-INF/com/google/android/updater-script"
ui_print("-------------------------------------");
ui_print("   Automated Port for POCO F3 (Alioth)");
ui_print("-------------------------------------");
ui_print("Flashing Boot image...");
package_extract_file("boot.img", "/dev/block/bootdevice/by-name/boot");
ui_print("Flashing DTBO...");
package_extract_file("dtbo.img", "/dev/block/bootdevice/by-name/dtbo");
ui_print("Patching Vbmeta...");
package_extract_file("vbmeta.img", "/dev/block/bootdevice/by-name/vbmeta");

# Note: This implies your TWRP handles logical partitions automatically
# or uses a binary like update_engine_sideload.
# For standard zip flash, we assume users use 'fastboot update' 
# or a TWRP that supports raw img flashing to super.
ui_print("Writing System & Vendor to Super partition...");
# Warning: Pure script flashing of dynamic partitions is complex.
# This is a simplified placeholder. Ideally, use 'dynamic_partitions_op_list'
ui_print("Done. Format Data is recommended.");
EOF

# –î–æ–±–∞–≤–ª—è–µ–º update-binary (—Ñ–∏–∫—Ç–∏–≤–Ω—ã–π, —Ç–∞–∫ –∫–∞–∫ updater-script –Ω–∞ —Å—Ç–∞—Ä–æ–º —è–∑—ã–∫–µ)
# –í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö ROM –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å META-INF –æ—Ç LineageOS –¥–ª—è Alioth.
# –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç –∑–∞–≥–ª—É—à–∫—É, —á—Ç–æ–±—ã ZIP –æ—Ç–∫—Ä—ã–≤–∞–ª—Å—è.
echo "#!/sbin/sh" > "$OUT_DIR/META-INF/com/google/android/update-binary"
chmod +x "$OUT_DIR/META-INF/com/google/android/update-binary"

echo "=== PORTING COMPLETE ==="
