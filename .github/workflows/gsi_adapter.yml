name: GSI Adapter for POCO F3 (Fixed Permissions)

on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: 'Direct Link to GSI (img, xz, gz, zip)'
        required: true
      base_url:
        description: 'Direct Link to Base ROM (Vendor)'
        required: true
      rom_name:
        description: 'Release Name'
        required: true
        default: 'PocoF3_GSI_Mod'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: üóëÔ∏è Disk Cleanup
        run: |
          # –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –º–µ—Å—Ç–∞
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: ‚öôÔ∏è Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip curl wget xz-utils android-sdk-libsparse-utils e2fsprogs f2fs-tools
          
          # Payload Dumper
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz

      - name: üì• Download & Extract
        run: |
          mkdir -p workspace/gsi workspace/base
          
          # --- GSI ---
          echo "Downloading GSI..."
          wget -q -O gsi_archive "${{ inputs.gsi_url }}"
          
          echo "Extracting GSI..."
          if [[ "${{ inputs.gsi_url }}" == *.xz ]]; then
            xz -d -c gsi_archive > workspace/gsi/system.img
          elif [[ "${{ inputs.gsi_url }}" == *.gz ]]; then
            gunzip -c gsi_archive > workspace/gsi/system.img
          elif [[ "${{ inputs.gsi_url }}" == *.zip ]]; then
            unzip -q gsi_archive -d workspace/gsi
            find workspace/gsi -name "*.img" -exec mv {} workspace/gsi/system.img \;
          else
            mv gsi_archive workspace/gsi/system.img
          fi
          rm -f gsi_archive

          # --- BASE ROM ---
          echo "Downloading Base..."
          wget -q -O base.zip "${{ inputs.base_url }}"
          unzip -q base.zip -d base_tmp
          rm base.zip
          
          # –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å vendor/boot
          if [ -f "base_tmp/payload.bin" ]; then
            payload-dumper-go -p vendor,boot,dtbo,vbmeta -o workspace/base base_tmp/payload.bin
          else
            # –ò—â–µ–º —Ñ–∞–π–ª—ã —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ, –µ—Å–ª–∏ –æ–Ω–∏ –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö
            find base_tmp -name "vendor.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "boot.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "dtbo.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "vbmeta.img" -exec mv {} workspace/base/ \;
          fi
          rm -rf base_tmp

      - name: üõ†Ô∏è Run Adapter Script
        run: |
          if [ ! -f "adapter.sh" ]; then
            echo "‚ùå Error: adapter.sh is missing!"
            exit 1
          fi
          chmod +x adapter.sh
          # –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –æ—Ç ROOT (—á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø—Ä–∞–≤)
          sudo ./adapter.sh "$(pwd)/workspace/gsi" "$(pwd)/workspace/base"

      - name: üóúÔ∏è Pack & Release (FIXED)
        run: |
          echo "Fixing permissions..."
          # –í–û–¢ –≠–¢–û –ò–°–ü–†–ê–í–õ–Ø–ï–¢ –û–®–ò–ë–ö–£ 18:
          sudo chown -R $USER:$USER workspace/out
          
          cd workspace/out
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ —É–ø–∞–∫–æ–≤–∫–æ–π
          ls -lh
          
          echo "Zipping..."
          zip -r1 ../${{ inputs.rom_name }}.zip ./*
          
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/${{ inputs.rom_name }}.zip
          tag_name: ${{ github.run_id }}
          name: ${{ inputs.rom_name }}
          body: |
            Automated GSI Port.
            Source GSI: ${{ inputs.gsi_url }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
