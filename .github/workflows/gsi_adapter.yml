name: GSI Adapter for POCO F3 (Final)

on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: 'Direct Link to GSI (img, xz, gz, zip)'
        required: true
      base_url:
        description: 'Direct Link to Base ROM (Vendor)'
        required: true
      rom_name:
        description: 'Release Name'
        required: true
        default: 'PocoF3_GSI_Mod'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: üóëÔ∏è Disk Cleanup (Manual)
        run: |
          # –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞, —Ç–∞–∫ –∫–∞–∫ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ actions –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã
          echo "Cleaning up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "Disk space available:"
          df -h

      - name: ‚öôÔ∏è Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip curl wget xz-utils android-sdk-libsparse-utils e2fsprogs f2fs-tools
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ payload-dumper-go
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz

      - name: üì• Download & Extract
        run: |
          mkdir -p workspace/gsi workspace/base
          
          # --- GSI ---
          echo "Downloading GSI..."
          wget -q -O gsi_archive "${{ inputs.gsi_url }}"
          
          echo "Extracting GSI..."
          # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∞—Ä—Ö–∏–≤–æ–≤
          if [[ "${{ inputs.gsi_url }}" == *.xz ]]; then
            xz -d -c gsi_archive > workspace/gsi/system.img
          elif [[ "${{ inputs.gsi_url }}" == *.gz ]]; then
            gunzip -c gsi_archive > workspace/gsi/system.img
          elif [[ "${{ inputs.gsi_url }}" == *.zip ]]; then
            unzip -q gsi_archive -d workspace/gsi
            find workspace/gsi -name "*.img" -exec mv {} workspace/gsi/system.img \;
          else
            mv gsi_archive workspace/gsi/system.img
          fi
          rm -f gsi_archive

          # --- BASE ROM ---
          echo "Downloading Base..."
          wget -q -O base.zip "${{ inputs.base_url }}"
          unzip -q base.zip -d base_tmp
          rm base.zip
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º Vendor –∏ Boot
          if [ -f "base_tmp/payload.bin" ]; then
            payload-dumper-go -p vendor,boot,dtbo,vbmeta -o workspace/base base_tmp/payload.bin
          else
            # –ï—Å–ª–∏ —ç—Ç–æ Fastboot ROM (img —Ñ–∞–π–ª—ã –ª–µ–∂–∞—Ç –≤ –ø–∞–ø–∫–µ)
            find base_tmp -name "vendor.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "boot.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "dtbo.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "vbmeta.img" -exec mv {} workspace/base/ \;
          fi
          rm -rf base_tmp

      - name: üõ†Ô∏è Run Adapter Script
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–∫—Ä–∏–ø—Ç–∞
          if [ ! -f "adapter.sh" ]; then
            echo "‚ùå Error: adapter.sh not found! Please create it in the repo."
            exit 1
          fi
          
          chmod +x adapter.sh
          # –ó–∞–ø—É—Å–∫ –æ—Ç root (—Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª—ã —Å –ø—Ä–∞–≤–∞–º–∏ root)
          sudo ./adapter.sh "$(pwd)/workspace/gsi" "$(pwd)/workspace/base"

      - name: üóúÔ∏è Pack & Release (Fixed Permissions)
        run: |
          echo "Fixing permissions..."
          # –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:
          # –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤ —Å root –Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (runner)
          sudo chown -R $USER:$USER workspace/out
          
          cd workspace/out
          echo "Zipping..."
          zip -r1 ../${{ inputs.rom_name }}.zip ./*
          
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/${{ inputs.rom_name }}.zip
          tag_name: ${{ github.run_id }}
          name: ${{ inputs.rom_name }}
          body: |
            GSI Port for POCO F3
            Base: ${{ inputs.base_url }}
            GSI: ${{ inputs.gsi_url }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
