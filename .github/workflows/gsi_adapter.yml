name: GSI Adapter for POCO F3

on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: '–°—Å—ã–ª–∫–∞ –Ω–∞ GSI (img, xz, gz –∏–ª–∏ zip)'
        required: true
      base_url:
        description: '–°—Å—ã–ª–∫–∞ –Ω–∞ Base ROM (Vendor)'
        required: true
      rom_name:
        description: '–ò–º—è —Ä–µ–ª–∏–∑–∞'
        required: true
        default: 'PocoF3_GSI_Mod'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: üóëÔ∏è Disk Cleanup (Manual)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force
          echo "Space available:"
          df -h

      - name: ‚öôÔ∏è Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip curl wget xz-utils android-sdk-libsparse-utils e2fsprogs
          
          # Payload Dumper –¥–ª—è MIUI/Base ROM
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/

      - name: üì• Download & Extract
        run: |
          mkdir -p workspace/gsi workspace/base
          
          # 1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ GSI
          echo "Downloading GSI..."
          wget -q -O gsi_archive "${{ inputs.gsi_url }}"
          
          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∞—Ä—Ö–∏–≤–∞ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞
          echo "Extracting GSI..."
          if [[ "${{ inputs.gsi_url }}" == *.xz ]]; then
            xz -d -c gsi_archive > workspace/gsi/system.img
          elif [[ "${{ inputs.gsi_url }}" == *.gz ]]; then
            gunzip -c gsi_archive > workspace/gsi/system.img
          elif [[ "${{ inputs.gsi_url }}" == *.zip ]]; then
            unzip -q gsi_archive -d workspace/gsi
            # –ò—â–µ–º img –≤–Ω—É—Ç—Ä–∏ –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º
            find workspace/gsi -name "*.img" -exec mv {} workspace/gsi/system.img \;
          else
            mv gsi_archive workspace/gsi/system.img
          fi
          rm -f gsi_archive

          # 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Base ROM
          echo "Downloading Base..."
          wget -q -O base.zip "${{ inputs.base_url }}"
          unzip -q base.zip -d base_tmp
          rm base.zip
          
          # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ Vendor/Boot –∏–∑ Base
          if [ -f "base_tmp/payload.bin" ]; then
            payload-dumper-go -p vendor,boot,dtbo,vbmeta -o workspace/base base_tmp/payload.bin
          else
            # –ï—Å–ª–∏ —ç—Ç–æ Fastboot ROM
            find base_tmp -name "vendor.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "boot.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "dtbo.img" -exec mv {} workspace/base/ \;
            find base_tmp -name "vbmeta.img" -exec mv {} workspace/base/ \;
          fi
          rm -rf base_tmp

      - name: üõ†Ô∏è Run Adapter Script
        run: |
          chmod +x adapter.sh
          sudo ./adapter.sh "$(pwd)/workspace/gsi" "$(pwd)/workspace/base"

      - name: üóúÔ∏è Pack & Release
        run: |
          cd workspace/out
          zip -r1 ../${{ inputs.rom_name }}.zip ./*
          
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/${{ inputs.rom_name }}.zip
          tag_name: ${{ github.run_id }}
          name: ${{ inputs.rom_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
