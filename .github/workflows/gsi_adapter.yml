name: GSI Adapter (Universal Unpack)

on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: '–°—Å—ã–ª–∫–∞ –Ω–∞ GSI'
        required: true
      base_url:
        description: '–°—Å—ã–ª–∫–∞ –Ω–∞ Base ROM (Fastboot tgz –∏–ª–∏ Recovery zip)'
        required: true
      rom_name:
        description: '–ò–º—è —Ä–µ–ª–∏–∑–∞'
        required: true
        default: 'PocoF3_GSI'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: üóëÔ∏è Clean Disk
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force

      - name: ‚öôÔ∏è Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip curl wget xz-utils android-sdk-libsparse-utils e2fsprogs f2fs-tools
          
          # 1. Payload Dumper (–¥–ª—è Recovery ROM)
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz
          
          # 2. LPUNPACK (–î–ª—è Fastboot ROM —Å super.img)
          # –°–∫–∞—á–∏–≤–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –±–∏–Ω–∞—Ä–Ω–∏–∫
          wget -q -O lpunpack https://github.com/tekidoer/vendor_f2fs/raw/master/bin/lpunpack
          chmod +x lpunpack
          sudo mv lpunpack /usr/local/bin/

      - name: üì• Download & Smart Extract
        run: |
          mkdir -p workspace/gsi workspace/base
          
          # --- GSI ---
          echo "Processing GSI..."
          wget -q -O gsi_archive "${{ inputs.gsi_url }}"
          if [[ "${{ inputs.gsi_url }}" == *.xz ]]; then
            xz -d -c gsi_archive > workspace/gsi/system.img
          elif [[ "${{ inputs.gsi_url }}" == *.gz ]]; then
            gunzip -c gsi_archive > workspace/gsi/system.img
          elif [[ "${{ inputs.gsi_url }}" == *.zip ]]; then
            unzip -q gsi_archive -d workspace/gsi
            find workspace/gsi -name "*.img" -exec mv {} workspace/gsi/system.img \;
          else
            mv gsi_archive workspace/gsi/system.img
          fi
          rm -f gsi_archive

          # --- BASE ROM (–£–ú–ù–ê–Ø –†–ê–°–ü–ê–ö–û–í–ö–ê) ---
          echo "Processing Base ROM..."
          wget -q -O base_rom "${{ inputs.base_url }}"
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
          mkdir -p base_tmp
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∞—Ä—Ö–∏–≤–∞ (zip –∏–ª–∏ tgz/tar.gz)
          if [[ "${{ inputs.base_url }}" == *.tgz ]] || [[ "${{ inputs.base_url }}" == *.tar.gz ]]; then
             echo "Detected Fastboot ROM (tgz)..."
             tar -zxf base_rom -C base_tmp
          else
             echo "Detected Zip ROM..."
             unzip -q base_rom -d base_tmp
          fi
          rm base_rom
          
          # --- –ü–û–ò–°–ö –§–ê–ô–õ–û–í ---
          cd base_tmp
          
          # –°—Ü–µ–Ω–∞—Ä–∏–π 1: Recovery ROM (payload.bin)
          if [ -f "payload.bin" ] || [ -n "$(find . -name 'payload.bin')" ]; then
            echo "Found payload.bin! Extracting..."
            find . -name "payload.bin" -exec cp {} . \;
            payload-dumper-go -p vendor,boot,dtbo,vbmeta,product,odm -o ../workspace/base payload.bin
          
          # –°—Ü–µ–Ω–∞—Ä–∏–π 2: Fastboot ROM (super.img)
          else
            echo "Searching for super.img / images..."
            
            # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ —Ñ–∞–π–ª—ã (boot, vbmeta...), –µ—Å–ª–∏ –æ–Ω–∏ –ª–µ–∂–∞—Ç —è–≤–Ω–æ
            find . -name "boot.img" -exec cp {} ../workspace/base/ \;
            find . -name "dtbo.img" -exec cp {} ../workspace/base/ \;
            find . -name "vbmeta.img" -exec cp {} ../workspace/base/ \;
            
            # –ò—â–µ–º Super.img (–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø–∞–ø–∫–µ images)
            SUPER_PATH=$(find . -name "super.img" | head -n 1)
            
            if [ ! -z "$SUPER_PATH" ]; then
                echo "Found super.img at $SUPER_PATH. Unpacking..."
                
                # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Sparse -> Raw (Fastboot –æ–±—Ä–∞–∑—ã —á–∞—Å—Ç–æ Sparse)
                if file "$SUPER_PATH" | grep -q "sparse"; then
                    echo "Converting sparse super to raw..."
                    simg2img "$SUPER_PATH" super.raw
                    mv super.raw super.img
                    SUPER_PATH="super.img"
                else
                    # –ï—Å–ª–∏ –ø—É—Ç—å –≥–ª—É–±–æ–∫–∏–π, –∫–æ–ø–∏—Ä—É–µ–º —Å—é–¥–∞
                    cp "$SUPER_PATH" super.img
                    SUPER_PATH="super.img"
                fi
                
                # 2. –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ lpunpack
                # –ò–∑–≤–ª–µ–∫–∞–µ–º vendor, product, odm –≤ –ø–∞–ø–∫—É –±–∞–∑—ã
                echo "Running lpunpack..."
                lpunpack "$SUPER_PATH" ../workspace/base
            else
                 # –°—Ü–µ–Ω–∞—Ä–∏–π 3: Vendor –ª–µ–∂–∏—Ç –æ—Ç–¥–µ–ª—å–Ω–æ (—Ä–µ–¥–∫–æ, –Ω–æ –±—ã–≤–∞–µ—Ç)
                 find . -name "vendor.img" -exec cp {} ../workspace/base/ \;
            fi
          fi
          
          cd ..
          rm -rf base_tmp

      - name: üõ†Ô∏è Run Adapter Script
        run: |
          if [ ! -f "adapter.sh" ]; then
             echo "‚ùå adapter.sh missing"
             exit 1
          fi
          chmod +x adapter.sh
          # –ó–∞–ø—É—Å–∫ –æ—Ç root
          sudo ./adapter.sh "$(pwd)/workspace/gsi" "$(pwd)/workspace/base"

      - name: üóúÔ∏è Pack & Release
        run: |
          echo "Fixing permissions..."
          sudo chown -R $USER:$USER workspace/out
          
          cd workspace/out
          echo "Zipping..."
          zip -r1 ../${{ inputs.rom_name }}.zip ./*

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/${{ inputs.rom_name }}.zip
          tag_name: ${{ github.run_id }}
          name: ${{ inputs.rom_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
