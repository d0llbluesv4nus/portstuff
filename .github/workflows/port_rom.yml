name: POCO F3 ROM Porter (Final Fix)

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ-Ð”ÐžÐÐžÐ  (Source)'
        required: true
      base_url:
        description: 'Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ-Ð‘ÐÐ—Ð£ (Vendor/Base)'
        required: true
      rom_name:
        description: 'Ð˜Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ð½Ð° Ð²Ñ‹Ñ…Ð¾Ð´Ðµ'
        required: true
        default: 'Alioth_Port'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: ðŸ—‘ï¸ Clean Disk
        run: |
          # Ð ÑƒÑ‡Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð¼ÐµÑÑ‚Ð°
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: âš™ï¸ Install Tools (Fixed Exit Code 8)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 1. ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ needrestart (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Exit code 8)
          sudo sed -i 's/#$nrconf{restart} = '"'"'i'"'"';/$nrconf{restart} = '"'"'a'"'"';/g' /etc/needrestart/needrestart.conf
          
          sudo apt-get update
          sudo apt-get install -y git zip unzip curl wget python3 python3-pip android-sdk-libsparse-utils e2fsprogs f2fs-tools brotli
          
          # 2. Payload Dumper Go
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz
          
          # 3. LPUNPACK
          wget -q -O lpunpack https://github.com/tekidoer/vendor_f2fs/raw/master/bin/lpunpack
          chmod +x lpunpack
          sudo mv lpunpack /usr/local/bin/
          
          # 4. sdat2img
          wget -q -O /usr/local/bin/sdat2img.py https://raw.githubusercontent.com/xpirt/sdat2img/master/sdat2img.py
          chmod +x /usr/local/bin/sdat2img.py

      - name: ðŸ“¥ Download & Extract (Smart Mode)
        run: |
          mkdir -p workspace/source workspace/base
          
          # === Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯ Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐžÐ™ Ð—ÐÐ“Ð Ð£Ð—ÐšÐ˜ Ð˜ Ð ÐÐ¡ÐŸÐÐšÐžÐ’ÐšÐ˜ ===
          extract_rom() {
              URL=$1
              OUT_DIR=$2
              ARCHIVE_NAME="rom_archive.zip"
              
              # --- Ð›ÐžÐ“Ð˜ÐšÐ Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð¡Ð¡Ð«Ð›ÐžÐš ---
              
              # PIXELDRAIN
              if [[ "$URL" == *"pixeldrain.com"* ]] && [[ "$URL" == *"/u/"* ]]; then
                  echo "Detected Pixeldrain. Converting link..."
                  URL=${URL//\/u\//\/api\/file\/}
              fi
              
              # SOURCEFORGE
              if [[ "$URL" == *"sourceforge.net"* ]]; then
                  if [[ "$URL" != *"/download" ]]; then
                      echo "Detected SourceForge. Adding suffix..."
                      URL="${URL}/download"
                  fi
              fi
              
              echo "Downloading from: $URL"
              
              # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ (User-Agent Ð´Ð»Ñ Ð¾Ð±Ñ…Ð¾Ð´Ð° Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹)
              wget -U "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" --max-redirect=20 -q -O $ARCHIVE_NAME "$URL"
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð°
              if unzip -t $ARCHIVE_NAME >/dev/null 2>&1; then
                  echo "Zip detected. Extracting..."
                  unzip -q $ARCHIVE_NAME -d temp_extract
              elif tar -tf $ARCHIVE_NAME >/dev/null 2>&1; then
                   echo "Tar/Tgz detected. Extracting..."
                   mkdir -p temp_extract
                   tar -xf $ARCHIVE_NAME -C temp_extract
              else
                   echo "âŒ ERROR: Download failed or invalid archive!"
                   rm $ARCHIVE_NAME
                   exit 1
              fi
              rm $ARCHIVE_NAME
              
              # --- Ð›ÐžÐ“Ð˜ÐšÐ ÐŸÐžÐ˜Ð¡ÐšÐ ÐžÐ‘Ð ÐÐ—ÐžÐ’ ---
              cd temp_extract
              
              # A: Payload.bin
              if [ -f "payload.bin" ]; then
                  echo "Found payload.bin"
                  payload-dumper-go -o ../$OUT_DIR payload.bin
                  
              # B: Super.img
              elif [ -n "$(find . -name 'super.img')" ]; then
                  SUPER=$(find . -name 'super.img' | head -n 1)
                  echo "Found super.img at $SUPER"
                  
                  if file "$SUPER" | grep -q "sparse"; then
                      echo "Desparsing super.img..."
                      simg2img "$SUPER" super.raw; mv super.raw super.img; SUPER="super.img"
                  else
                      mv "$SUPER" super.img; SUPER="super.img"
                  fi
                  lpunpack "$SUPER" ../$OUT_DIR
                  
              # C: Brotli (.new.dat.br)
              elif [ -f "system.new.dat.br" ]; then
                  echo "Found Brotli DAT files"
                  brotli --decompress system.new.dat.br
                  python3 /usr/local/bin/sdat2img.py system.transfer.list system.new.dat ../$OUT_DIR/system.img
                  
                  if [ -f "vendor.new.dat.br" ]; then
                      brotli --decompress vendor.new.dat.br
                      python3 /usr/local/bin/sdat2img.py vendor.transfer.list vendor.new.dat ../$OUT_DIR/vendor.img
                  fi
                  find . -name "boot.img" -exec cp {} ../$OUT_DIR/ \;
                  
              else
                  # D: Raw Images
                  echo "Assuming raw images..."
                  find . -name "*.img" -exec mv {} ../$OUT_DIR/ \;
              fi
              
              cd ..
              rm -rf temp_extract
          }

          # Ð—ÐÐŸÐ£Ð¡Ðš Ð ÐÐ¡ÐŸÐÐšÐžÐ’ÐšÐ˜
          echo ">>> PROCESSING SOURCE ROM <<<"
          extract_rom "${{ inputs.source_url }}" "workspace/source"
          
          echo ">>> PROCESSING BASE ROM <<<"
          extract_rom "${{ inputs.base_url }}" "workspace/base"

      - name: ðŸ› ï¸ Run Porting Script
        run: |
          if [ ! -f "port.sh" ]; then
             echo "âŒ Error: port.sh missing!"
             exit 1
          fi
          chmod +x port.sh
          # Ð—Ð°Ð¿ÑƒÑÐº Ð¾Ñ‚ ROOT
          sudo ./port.sh "$(pwd)/workspace/source" "$(pwd)/workspace/base"

      - name: ðŸ—œï¸ Pack & Release (Fix Permissions)
        run: |
          echo "Fixing file permissions..."
          # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Permission Denied (Error 18)
          sudo chown -R $USER:$USER workspace/out
          
          cd workspace/out
          echo "Zipping..."
          zip -r1 ../${{ inputs.rom_name }}.zip ./*

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/${{ inputs.rom_name }}.zip
          tag_name: ${{ github.run_id }}
          name: ${{ inputs.rom_name }}
          body: |
            **Poco F3 Port**
            Source: ${{ inputs.source_url }}
            Base: ${{ inputs.base_url }}
            
            **Installation:**
            Unzip and run `flash_rom.bat` in Fastboot mode.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
