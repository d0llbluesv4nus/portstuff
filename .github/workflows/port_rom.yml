name: POCO F3 ROM Porter (Ultimate)

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ-Ð”ÐžÐÐžÐ  (Source)'
        required: true
      base_url:
        description: 'Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ-Ð‘ÐÐ—Ð£ (Vendor/Base)'
        required: true
      rom_name:
        description: 'Ð˜Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ð½Ð° Ð²Ñ‹Ñ…Ð¾Ð´Ðµ'
        required: true
        default: 'Alioth_Port'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: ðŸ—‘ï¸ Clean Disk
        run: |
          # ÐžÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ð°ÐµÐ¼ Ð¼ÐµÑÑ‚Ð¾ ÑƒÐ´Ð°Ð»ÑÑ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ð¹ ÑÐ¾Ñ„Ñ‚
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: âš™ï¸ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip curl wget python3 python3-pip android-sdk-libsparse-utils e2fsprogs f2fs-tools brotli
          
          # 1. Payload Dumper Go (Ð´Ð»Ñ Recovery ROM)
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz
          
          # 2. LPUNPACK (Ð”Ð»Ñ Fastboot ROM / super.img)
          wget -q -O lpunpack https://github.com/tekidoer/vendor_f2fs/raw/master/bin/lpunpack
          chmod +x lpunpack
          sudo mv lpunpack /usr/local/bin/
          
          # 3. sdat2img (Ð”Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² .dat.br)
          wget -q -O /usr/local/bin/sdat2img.py https://raw.githubusercontent.com/xpirt/sdat2img/master/sdat2img.py
          chmod +x /usr/local/bin/sdat2img.py

      - name: ðŸ“¥ Download & Extract (Smart Mode)
        run: |
          mkdir -p workspace/source workspace/base
          
          # === Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯ Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐžÐ™ Ð—ÐÐ“Ð Ð£Ð—ÐšÐ˜ Ð˜ Ð ÐÐ¡ÐŸÐÐšÐžÐ’ÐšÐ˜ ===
          extract_rom() {
              URL=$1
              OUT_DIR=$2
              ARCHIVE_NAME="rom_archive.zip"
              
              # --- Ð›ÐžÐ“Ð˜ÐšÐ Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð¡Ð¡Ð«Ð›ÐžÐš ---
              
              # 1. PIXELDRAIN (ÐŸÑ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ /u/ Ð² /api/file/)
              if [[ "$URL" == *"pixeldrain.com"* ]] && [[ "$URL" == *"/u/"* ]]; then
                  echo "Detected Pixeldrain. Converting to direct API link..."
                  URL=${URL//\/u\//\/api\/file\/}
              fi
              
              # 2. SOURCEFORGE (Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ /download ÐµÑÐ»Ð¸ Ð½ÐµÑ‚)
              if [[ "$URL" == *"sourceforge.net"* ]]; then
                  if [[ "$URL" != *"/download" ]]; then
                      echo "Detected SourceForge. Adding /download suffix..."
                      URL="${URL}/download"
                  fi
              fi
              
              echo "Downloading from: $URL"
              
              # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ñ Ð¼Ð°ÑÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹ Ð¿Ð¾Ð´ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ (User-Agent)
              wget -U "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" --max-redirect=20 -q -O $ARCHIVE_NAME "$URL"
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¸Ð¿Ð° Ð°Ñ€Ñ…Ð¸Ð²Ð°
              if unzip -t $ARCHIVE_NAME >/dev/null 2>&1; then
                  echo "Zip detected. Extracting..."
                  unzip -q $ARCHIVE_NAME -d temp_extract
              elif tar -tf $ARCHIVE_NAME >/dev/null 2>&1; then
                   echo "Tar/Tgz detected. Extracting..."
                   mkdir -p temp_extract
                   tar -xf $ARCHIVE_NAME -C temp_extract
              else
                   echo "âŒ ERROR: Download failed or file is not an archive!"
                   rm $ARCHIVE_NAME
                   exit 1
              fi
              rm $ARCHIVE_NAME
              
              # --- Ð›ÐžÐ“Ð˜ÐšÐ ÐŸÐžÐ˜Ð¡ÐšÐ ÐžÐ‘Ð ÐÐ—ÐžÐ’ ---
              cd temp_extract
              
              # Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ A: Payload.bin
              if [ -f "payload.bin" ]; then
                  echo "Found payload.bin"
                  payload-dumper-go -o ../$OUT_DIR payload.bin
                  
              # Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ B: Super.img
              elif [ -n "$(find . -name 'super.img')" ]; then
                  SUPER=$(find . -name 'super.img' | head -n 1)
                  echo "Found super.img at $SUPER"
                  
                  # ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ñ Sparse -> Raw (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
                  if file "$SUPER" | grep -q "sparse"; then
                      echo "Desparsing super.img..."
                      simg2img "$SUPER" super.raw; mv super.raw super.img; SUPER="super.img"
                  else
                      mv "$SUPER" super.img; SUPER="super.img"
                  fi
                  # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ°
                  lpunpack "$SUPER" ../$OUT_DIR
                  
              # Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ C: Brotli (.new.dat.br)
              elif [ -f "system.new.dat.br" ]; then
                  echo "Found Brotli DAT files"
                  brotli --decompress system.new.dat.br
                  python3 /usr/local/bin/sdat2img.py system.transfer.list system.new.dat ../$OUT_DIR/system.img
                  
                  if [ -f "vendor.new.dat.br" ]; then
                      brotli --decompress vendor.new.dat.br
                      python3 /usr/local/bin/sdat2img.py vendor.transfer.list vendor.new.dat ../$OUT_DIR/vendor.img
                  fi
                  # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Boot
                  find . -name "boot.img" -exec cp {} ../$OUT_DIR/ \;
                  
              else
                  # Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ D: ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
                  echo "Assuming raw images..."
                  find . -name "*.img" -exec mv {} ../$OUT_DIR/ \;
              fi
              
              cd ..
              rm -rf temp_extract
          }

          # Ð—ÐÐŸÐ£Ð¡Ðš Ð ÐÐ¡ÐŸÐÐšÐžÐ’ÐšÐ˜
          echo ">>> PROCESSING SOURCE ROM <<<"
          extract_rom "${{ inputs.source_url }}" "workspace/source"
          
          echo ">>> PROCESSING BASE ROM <<<"
          extract_rom "${{ inputs.base_url }}" "workspace/base"

      - name: ðŸ› ï¸ Run Porting Script
        run: |
          if [ ! -f "port.sh" ]; then
             echo "âŒ Error: port.sh is missing in the repository!"
             exit 1
          fi
          chmod +x port.sh
          # Ð—Ð°Ð¿ÑƒÑÐº Ð¾Ñ‚ ROOT
          sudo ./port.sh "$(pwd)/workspace/source" "$(pwd)/workspace/base"

      - name: ðŸ—œï¸ Pack & Release (Fix Permissions)
        run: |
          echo "Fixing file permissions (Solving Error 18)..."
          # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ runner
          sudo chown -R $USER:$USER workspace/out
          
          cd workspace/out
          echo "Files to zip:"
          ls -lh
          
          echo "Zipping..."
          zip -r1 ../${{ inputs.rom_name }}.zip ./*

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/${{ inputs.rom_name }}.zip
          tag_name: ${{ github.run_id }}
          name: ${{ inputs.rom_name }}
          body: |
            **Poco F3 Port**
            Source: ${{ inputs.source_url }}
            Base: ${{ inputs.base_url }}
            
            **Installation:**
            Unzip and run `flash_rom.bat` in Fastboot mode.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
