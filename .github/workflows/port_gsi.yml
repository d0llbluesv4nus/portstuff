name: GSI System Patcher (No Boot)

on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: 'Прямая ссылка на GSI (system.img.xz или zip)'
        required: true
      rom_name:
        description: 'Имя выходного архива'
        required: true
        default: 'PocoF3_GSI_SystemOnly'

jobs:
  patch:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cleanup Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget unzip zip tar axel python3 android-sdk-libsparse-utils e2fsprogs simg2img
          
          # Инструменты для работы с EROFS (чтение/распаковка)
          sudo apt-get install -y erofs-utils

          chmod +x scripts/process.sh

      - name: Run Patcher Script
        run: |
          sudo bash scripts/process.sh "${{ github.event.inputs.gsi_url }}" "${{ github.event.inputs.rom_name }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.rom_name }}
          path: build/output/*.zip
