name: Ultimate POCO F3 Porter

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'URL –¥–æ–Ω–æ—Ä–∞ (Source ROM)'
        required: true
      base_url:
        description: 'URL –±–∞–∑—ã (Base ROM / Vendor)'
        required: true
      rom_name:
        description: '–ò–º—è –¥–ª—è —Ä–µ–ª–∏–∑–∞'
        required: true
        default: 'Alioth_Port'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: üóëÔ∏è Maximize Disk Space
        uses: rokibhasanio/tarater@v1
        with:
          free_swap: true
          free_root: true
          
      - name: ‚öôÔ∏è Install Modding Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip curl wget python3 python3-pip
          sudo apt-get install -y android-sdk-libsparse-utils e2fsprogs f2fs-tools
          
          # –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ payload.bin
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz

      - name: üì• Download & Extract
        run: |
          mkdir -p workspace/source workspace/base
          
          # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ (Quiet mode)
          echo "Downloading Source..."
          wget -q -O source.zip "${{ inputs.rom_url }}"
          echo "Downloading Base..."
          wget -q -O base.zip "${{ inputs.base_url }}"
          
          # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ Source
          echo "Extracting Source..."
          unzip -q source.zip -d src_tmp
          rm source.zip
          if [ -f "src_tmp/payload.bin" ]; then
            payload-dumper-go -o workspace/source src_tmp/payload.bin
          else
            # –ï—Å–ª–∏ –æ–±—Ä–∞–∑—ã –ª–µ–∂–∞—Ç –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫ –∏–ª–∏ –≤ –ø–∞–ø–∫–µ images
            find src_tmp -name "*.img" -exec mv {} workspace/source/ \;
          fi
          rm -rf src_tmp

          # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ Base
          echo "Extracting Base..."
          unzip -q base.zip -d base_tmp
          rm base.zip
          if [ -f "base_tmp/payload.bin" ]; then
            payload-dumper-go -o workspace/base base_tmp/payload.bin
          else
            find base_tmp -name "*.img" -exec mv {} workspace/base/ \;
          fi
          rm -rf base_tmp

      - name: üõ†Ô∏è Run Deep Porting Logic
        run: |
          chmod +x porting_logic.sh
          # –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —Å –ø—Ä–∞–≤–∞–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          sudo ./porting_logic.sh "$(pwd)/workspace/source" "$(pwd)/workspace/base"

      - name: üóúÔ∏è Zip & Upload
        run: |
          cd workspace/out
          echo "Zipping (Fast mode)..."
          zip -r1 ../${{ inputs.rom_name }}.zip ./*
          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/${{ inputs.rom_name }}.zip
          tag_name: ${{ github.run_id }}
          name: ${{ inputs.rom_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
