name: Ultimate POCO F3 Porter (Fixed)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'URL –¥–æ–Ω–æ—Ä–∞ (Source ROM)'
        required: true
      base_url:
        description: 'URL –±–∞–∑—ã (Base ROM / Vendor)'
        required: true
      rom_name:
        description: '–ò–º—è –¥–ª—è —Ä–µ–ª–∏–∑–∞'
        required: true
        default: 'Alioth_Port'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –®–ê–ì –û–ß–ò–°–¢–ö–ò ---
      - name: üóëÔ∏è Free Disk Space (Manual)
        run: |
          echo "Freeing up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo rm -rf /etc/mysql /etc/php
          echo "Disk space after cleanup:"
          df -h
      # -------------------------------
          
      - name: ‚öôÔ∏è Install Modding Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip curl wget python3 python3-pip
          sudo apt-get install -y android-sdk-libsparse-utils e2fsprogs f2fs-tools
          
          # –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ payload.bin
          wget -q https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -zxf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz

      - name: üì• Download & Extract
        run: |
          mkdir -p workspace/source workspace/base
          
          # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ (Quiet mode)
          echo "Downloading Source..."
          wget -q -O source.zip "${{ inputs.rom_url }}"
          echo "Downloading Base..."
          wget -q -O base.zip "${{ inputs.base_url }}"
          
          # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ Source
          echo "Extracting Source..."
          unzip -q source.zip -d src_tmp
          rm source.zip
          if [ -f "src_tmp/payload.bin" ]; then
            payload-dumper-go -o workspace/source src_tmp/payload.bin
          else
            find src_tmp -name "*.img" -exec mv {} workspace/source/ \;
          fi
          rm -rf src_tmp

          # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ Base
          echo "Extracting Base..."
          unzip -q base.zip -d base_tmp
          rm base.zip
          if [ -f "base_tmp/payload.bin" ]; then
            payload-dumper-go -o workspace/base base_tmp/payload.bin
          else
            find base_tmp -name "*.img" -exec mv {} workspace/base/ \;
          fi
          rm -rf base_tmp

      - name: üõ†Ô∏è Run Deep Porting Logic
        run: |
          # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞
          if [ -f "porting_logic.sh" ]; then
            chmod +x porting_logic.sh
            sudo ./porting_logic.sh "$(pwd)/workspace/source" "$(pwd)/workspace/base"
          else
            echo "‚ùå Error: porting_logic.sh not found in repository!"
            exit 1
          fi

      - name: üóúÔ∏è Zip & Upload
        run: |
          cd workspace/out
          echo "Zipping (Fast mode)..."
          zip -r1 ../${{ inputs.rom_name }}.zip ./*
          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/${{ inputs.rom_name }}.zip
          tag_name: ${{ github.run_id }}
          name: ${{ inputs.rom_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
